<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#0a0a0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="/manifest.json" />
  <title>ENDURO â€” Race Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:#0a0a0f;--bg2:#111118;--bg3:#1a1a24;
      --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.12);
      --text:#f0f0f5;--text2:#8888a0;--text3:#555568;
      --accent-run:#ff4d1c;--accent-trail:#22c55e;--accent-tri:#3b82f6;
      --accent-swim:#06b6d4;--accent-bike:#f59e0b;--gold:#f59e0b;
      --radius:16px;--radius-sm:10px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
    body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.3;}

    /* LOADING */
    #loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9000;}
    .loading-logo{font-family:'Bebas Neue',sans-serif;font-size:56px;letter-spacing:4px;color:var(--text);margin-bottom:32px;}
    .loading-bar{width:120px;height:3px;background:var(--bg3);border-radius:2px;overflow:hidden;}
    .loading-progress{height:100%;background:var(--accent-run);border-radius:2px;animation:loadAnim 1.5s ease infinite;}
    @keyframes loadAnim{0%{width:0;opacity:1}70%{width:100%;opacity:1}100%{width:100%;opacity:0}}
    .loading-text{margin-top:16px;font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);}

    /* AUTH */
    #auth-screen{display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(255,77,28,0.15) 0%,transparent 70%);}
    .auth-logo{font-family:'Bebas Neue',sans-serif;font-size:56px;letter-spacing:4px;margin-bottom:4px;}
    .auth-tagline{font-size:12px;letter-spacing:3px;text-transform:uppercase;color:var(--text3);margin-bottom:48px;}
    .auth-card{width:100%;max-width:400px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:32px 24px;}
    .auth-tabs{display:flex;gap:4px;background:var(--bg3);padding:4px;border-radius:var(--radius-sm);margin-bottom:28px;}
    .auth-tab{flex:1;padding:10px;background:transparent;border:none;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;border-radius:8px;transition:all 0.2s;}
    .auth-tab.active{background:var(--accent-run);color:#fff;}
    .field-group{margin-bottom:16px;}
    .field-group label{display:block;font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);margin-bottom:8px;}
    .field-group input,.field-group select{width:100%;padding:14px 16px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;outline:none;transition:border-color 0.2s;}
    .field-group input:focus,.field-group select:focus{border-color:var(--accent-run);}
    .field-group select option{background:var(--bg3);}
    .btn-primary{width:100%;padding:16px;background:var(--accent-run);border:none;border-radius:var(--radius-sm);color:#fff;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:opacity 0.2s,transform 0.1s;letter-spacing:0.5px;}
    .btn-primary:active{transform:scale(0.98);opacity:0.9;}
    .btn-primary:disabled{opacity:0.5;cursor:not-allowed;}
    .auth-error{margin-top:12px;padding:12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius-sm);color:#ef4444;font-size:13px;text-align:center;display:none;}

    /* APP */
    #app{display:none;min-height:100vh;padding-bottom:80px;}
    .topbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:rgba(10,10,15,0.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);}
    .topbar-logo{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:3px;}
    .topbar-user{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text2);}
    .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--accent-run),var(--accent-tri));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;}

    /* NAV */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:200;display:flex;background:rgba(10,10,15,0.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:8px 0 env(safe-area-inset-bottom,8px);}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;border:none;background:transparent;cursor:pointer;color:var(--text3);font-family:'DM Sans',sans-serif;font-size:10px;letter-spacing:0.5px;transition:color 0.2s;}
    .nav-item svg{width:22px;height:22px;}
    .nav-item.active{color:var(--accent-run);}
    .nav-item.active svg{stroke:var(--accent-run);}

    /* PAGES */
    .page{display:none;padding:20px;}
    .page.active{display:block;}
    .page-title{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:2px;margin-bottom:20px;}

    /* FEED */
    .feed-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;overflow:hidden;animation:fadeUp 0.4s ease both;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    .feed-card-header{display:flex;align-items:center;gap:12px;padding:16px 16px 12px;}
    .feed-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent-trail),var(--accent-tri));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#fff;flex-shrink:0;}
    .feed-meta{flex:1;}
    .feed-name{font-size:14px;font-weight:600;}
    .feed-date{font-size:12px;color:var(--text3);margin-top:2px;}
    .sport-badge{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;}
    .badge-trail{background:rgba(34,197,94,0.15);color:var(--accent-trail);border:1px solid rgba(34,197,94,0.3);}
    .badge-run{background:rgba(255,77,28,0.15);color:var(--accent-run);border:1px solid rgba(255,77,28,0.3);}
    .badge-tri{background:rgba(59,130,246,0.15);color:var(--accent-tri);border:1px solid rgba(59,130,246,0.3);}
    .pending-badge{background:rgba(245,158,11,0.15);color:var(--gold);border:1px solid rgba(245,158,11,0.3);padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;}
    .feed-race-name{padding:0 16px 12px;font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;}
    .feed-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-top:1px solid var(--border);}
    .stat-cell{background:var(--bg2);padding:14px 12px;text-align:center;}
    .stat-val{font-family:'DM Mono',monospace;font-size:18px;font-weight:500;}
    .stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}
    .tri-segments{padding:12px 16px;display:flex;flex-direction:column;gap:8px;}
    .tri-segment{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:10px;background:var(--bg3);}
    .seg-icon{font-size:18px;width:24px;text-align:center;}
    .seg-info{flex:1;}
    .seg-name{font-size:12px;font-weight:600;color:var(--text2);}
    .seg-detail{font-family:'DM Mono',monospace;font-size:13px;margin-top:2px;}
    .seg-time{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;}
    .seg-swim{color:var(--accent-swim);}
    .seg-bike{color:var(--accent-bike);}
    .seg-run-c{color:var(--accent-run);}
    .feed-actions{display:flex;align-items:center;gap:8px;padding:12px 16px;border-top:1px solid var(--border);}
    .btn-like{display:flex;align-items:center;gap:6px;padding:8px 14px;background:transparent;border:1px solid var(--border);border-radius:20px;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all 0.2s;}
    .btn-like.liked{border-color:var(--accent-run);color:var(--accent-run);background:rgba(255,77,28,0.08);}
    .btn-like svg{width:16px;height:16px;}

    /* ADD RACE */
    .sport-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:28px;}
    .sport-btn{padding:16px 8px;border:2px solid var(--border);border-radius:var(--radius-sm);background:var(--bg2);color:var(--text2);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;text-align:center;cursor:pointer;transition:all 0.2s;}
    .sport-btn span{display:block;font-size:24px;margin-bottom:8px;}
    .sport-btn.active-trail{border-color:var(--accent-trail);color:var(--accent-trail);background:rgba(34,197,94,0.08);}
    .sport-btn.active-run{border-color:var(--accent-run);color:var(--accent-run);background:rgba(255,77,28,0.08);}
    .sport-btn.active-tri{border-color:var(--accent-tri);color:var(--accent-tri);background:rgba(59,130,246,0.08);}
    .form-section{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;}
    .form-section-title{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:16px;}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .segment-section{border-left:3px solid;padding-left:16px;margin-bottom:20px;}
    .seg-swim-s{border-color:var(--accent-swim);}
    .seg-bike-s{border-color:var(--accent-bike);}
    .seg-run-s{border-color:var(--accent-run);}
    .segment-title{display:flex;align-items:center;gap:8px;font-size:14px;font-weight:600;margin-bottom:14px;}

    /* MY RACES */
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
    .stat-box{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:18px 16px;}
    .stat-box-val{font-family:'Bebas Neue',sans-serif;font-size:32px;letter-spacing:1px;}
    .stat-box-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}
    .section-label{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:14px;}
    .race-list-item{display:flex;align-items:center;gap:14px;padding:16px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;cursor:pointer;}
    .race-list-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
    .race-list-info{flex:1;}
    .race-list-name{font-size:15px;font-weight:600;}
    .race-list-meta{font-size:12px;color:var(--text3);margin-top:3px;}
    .race-list-time{font-family:'DM Mono',monospace;font-size:16px;}

    /* ADMIN */
    .admin-tabs{display:flex;gap:4px;background:var(--bg3);padding:4px;border-radius:var(--radius-sm);margin-bottom:20px;}
    .admin-tab{flex:1;padding:10px;background:transparent;border:none;color:var(--text2);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;border-radius:8px;transition:all 0.2s;}
    .admin-tab.active{background:var(--accent-run);color:#fff;}
    .admin-sub{display:none;}
    .admin-sub.active{display:block;}
    .admin-user-row{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;}
    .admin-avatar{width:36px;height:36px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;}
    .admin-user-info{flex:1;}
    .admin-user-name{font-size:14px;font-weight:600;}
    .admin-user-meta{font-size:11px;color:var(--text3);margin-top:2px;}
    .btn-sm-danger{padding:6px 12px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:6px;color:#ef4444;font-size:11px;font-weight:600;cursor:pointer;}
    .pending-card{background:var(--bg2);border:1px solid rgba(245,158,11,0.3);border-radius:var(--radius);padding:16px;margin-bottom:12px;}
    .pending-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .pending-card-name{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1px;}
    .pending-card-meta{font-size:12px;color:var(--text3);margin-bottom:8px;}
    .pending-actions{display:flex;gap:8px;margin-top:12px;}
    .btn-approve{flex:1;padding:10px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.4);border-radius:var(--radius-sm);color:var(--accent-trail);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
    .btn-reject{flex:1;padding:10px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius-sm);color:#ef4444;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
    .export-btn{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;cursor:pointer;}
    .export-btn-info{display:flex;align-items:center;gap:12px;}
    .export-btn-label{font-size:14px;font-weight:600;}
    .export-btn-desc{font-size:12px;color:var(--text3);margin-top:2px;}
    .btn-danger{width:100%;padding:14px;background:transparent;border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius-sm);color:#ef4444;font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:8px;}

    /* MODAL */
    .modal-overlay{display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);align-items:flex-end;}
    .modal-overlay.open{display:flex;}
    .modal{width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:24px 24px 0 0;padding:24px 20px 40px;max-height:90vh;overflow-y:auto;animation:slideUp 0.35s cubic-bezier(0.32,0.72,0,1);}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-handle{width:40px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 24px;}
    .modal-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;margin-bottom:20px;}
    .detail-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
    .detail-stat{background:var(--bg3);border-radius:var(--radius-sm);padding:14px;}
    .detail-stat-val{font-family:'DM Mono',monospace;font-size:20px;}
    .detail-stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}
    .btn-outline{width:100%;padding:14px;background:transparent;border:1px solid var(--border2);border-radius:var(--radius-sm);color:var(--text2);font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px;}

    /* TOAST */
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border2);border-radius:30px;padding:12px 20px;font-size:13px;font-weight:500;z-index:9000;opacity:0;transition:opacity 0.3s;white-space:nowrap;}
    .toast.show{opacity:1;}
    .empty-state{text-align:center;padding:48px 20px;color:var(--text3);}
    .empty-state-icon{font-size:48px;margin-bottom:16px;}
    .empty-state-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:var(--text2);margin-bottom:8px;}
    .empty-state-text{font-size:14px;line-height:1.6;}
    ::-webkit-scrollbar{width:4px;}
    ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
  </style>
</head>
<body>

<div id="loading-screen">
  <div class="loading-logo">ENDURO</div>
  <div class="loading-bar"><div class="loading-progress"></div></div>
  <div class="loading-text">Connexion en coursâ€¦</div>
</div>

<div id="auth-screen">
  <div class="auth-logo">ENDURO</div>
  <div class="auth-tagline">Race Performance Tracker</div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Connexion</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Inscription</button>
    </div>
    <div id="login-form">
      <div class="field-group"><label>Email</label><input type="email" id="login-email" placeholder="ton@email.com"/></div>
      <div class="field-group"><label>Mot de passe</label><input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
      <button class="btn-primary" id="login-btn" onclick="login()">Se connecter</button>
      <div class="auth-error" id="login-error"></div>
    </div>
    <div id="register-form" style="display:none">
      <div class="field-group"><label>Pseudo</label><input type="text" id="reg-pseudo" placeholder="ultrarunner42"/></div>
      <div class="field-group"><label>Email</label><input type="email" id="reg-email" placeholder="ton@email.com"/></div>
      <div class="field-group"><label>Mot de passe</label><input type="password" id="reg-password" placeholder="Minimum 6 caractÃ¨res"/></div>
      <div class="field-group">
        <label>NationalitÃ©</label>
        <select id="reg-country">
          <option value="">SÃ©lectionnerâ€¦</option>
          <option value="FR">ğŸ‡«ğŸ‡· France</option><option value="BE">ğŸ‡§ğŸ‡ª Belgique</option>
          <option value="CH">ğŸ‡¨ğŸ‡­ Suisse</option><option value="LU">ğŸ‡±ğŸ‡º Luxembourg</option>
          <option value="ES">ğŸ‡ªğŸ‡¸ Espagne</option><option value="IT">ğŸ‡®ğŸ‡¹ Italie</option>
          <option value="DE">ğŸ‡©ğŸ‡ª Allemagne</option><option value="GB">ğŸ‡¬ğŸ‡§ Royaume-Uni</option>
          <option value="US">ğŸ‡ºğŸ‡¸ Ã‰tats-Unis</option><option value="PT">ğŸ‡µğŸ‡¹ Portugal</option>
          <option value="NL">ğŸ‡³ğŸ‡± Pays-Bas</option><option value="AU">ğŸ‡¦ğŸ‡º Australie</option>
          <option value="CA">ğŸ‡¨ğŸ‡¦ Canada</option><option value="OTHER">ğŸŒ Autre</option>
        </select>
      </div>
      <button class="btn-primary" id="register-btn" onclick="register()">CrÃ©er mon compte</button>
      <div class="auth-error" id="register-error"></div>
    </div>
  </div>
</div>

<div id="app">
  <div class="topbar">
    <div class="topbar-logo">ENDURO</div>
    <div class="topbar-user">
      <span id="topbar-pseudo"></span>
      <div class="avatar" id="topbar-avatar">U</div>
      <button onclick="logout()" style="background:none;border:none;color:var(--text3);font-size:12px;cursor:pointer;">DÃ©co</button>
    </div>
  </div>

  <div id="page-feed" class="page active">
    <div style="padding-top:8px">
      <div class="page-title">Fil d'actu</div>
      <div id="feed-list"></div>
    </div>
  </div>

  <div id="page-add" class="page">
    <div class="page-title">Nouvelle course</div>
    <div class="sport-selector">
      <button class="sport-btn" onclick="selectSport('trail')" id="btn-trail"><span>â›°ï¸</span>Trail</button>
      <button class="sport-btn" onclick="selectSport('run')" id="btn-run"><span>ğŸƒ</span>Running</button>
      <button class="sport-btn" onclick="selectSport('tri')" id="btn-tri"><span>ğŸŠ</span>Triathlon</button>
    </div>
    <div class="form-section">
      <div class="form-section-title">Informations gÃ©nÃ©rales</div>
      <div class="field-group"><label>Nom de la course</label><input type="text" id="race-name" placeholder="UTMB, IronMan Niceâ€¦"/></div>
      <div class="row-2">
        <div class="field-group"><label>Date</label><input type="date" id="race-date"/></div>
        <div class="field-group"><label>Lieu</label><input type="text" id="race-location" placeholder="Chamonix"/></div>
      </div>
    </div>
    <div id="form-trail-run" class="form-section" style="display:none">
      <div class="form-section-title">Performance</div>
      <div class="row-2">
        <div class="field-group"><label>Distance (km)</label><input type="number" id="tr-distance" placeholder="42.2" step="0.1"/></div>
        <div class="field-group"><label>DÃ©nivelÃ© + (m)</label><input type="number" id="tr-denivele" placeholder="2500"/></div>
      </div>
      <div class="field-group"><label>Temps total (hh:mm:ss)</label><input type="text" id="tr-time" placeholder="03:45:00"/></div>
    </div>
    <div id="form-tri" style="display:none">
      <div class="form-section">
        <div class="segment-section seg-swim-s">
          <div class="segment-title"><span style="color:var(--accent-swim)">ğŸŠ Natation</span></div>
          <div class="row-2">
            <div class="field-group"><label>Distance (m)</label><input type="number" id="tri-swim-dist" placeholder="1500"/></div>
            <div class="field-group"><label>Temps (mm:ss)</label><input type="text" id="tri-swim-time" placeholder="22:00"/></div>
          </div>
        </div>
        <div class="field-group"><label>Transition T1 (mm:ss)</label><input type="text" id="tri-t1" placeholder="02:30"/></div>
      </div>
      <div class="form-section">
        <div class="segment-section seg-bike-s">
          <div class="segment-title"><span style="color:var(--accent-bike)">ğŸš´ VÃ©lo</span></div>
          <div class="row-2">
            <div class="field-group"><label>Distance (km)</label><input type="number" id="tri-bike-dist" placeholder="40" step="0.1"/></div>
            <div class="field-group"><label>DÃ©nivelÃ© + (m)</label><input type="number" id="tri-bike-denivele" placeholder="500"/></div>
          </div>
          <div class="field-group"><label>Temps (hh:mm:ss)</label><input type="text" id="tri-bike-time" placeholder="01:10:00"/></div>
        </div>
        <div class="field-group"><label>Transition T2 (mm:ss)</label><input type="text" id="tri-t2" placeholder="01:30"/></div>
      </div>
      <div class="form-section">
        <div class="segment-section seg-run-s">
          <div class="segment-title"><span style="color:var(--accent-run)">ğŸƒ Course Ã  pied</span></div>
          <div class="row-2">
            <div class="field-group"><label>Distance (km)</label><input type="number" id="tri-run-dist" placeholder="10" step="0.1"/></div>
            <div class="field-group"><label>DÃ©nivelÃ© + (m)</label><input type="number" id="tri-run-denivele" placeholder="100"/></div>
          </div>
          <div class="field-group"><label>Temps (hh:mm:ss)</label><input type="text" id="tri-run-time" placeholder="00:48:00"/></div>
        </div>
      </div>
    </div>
    <div id="save-btn-wrap" style="display:none">
      <button class="btn-primary" onclick="saveRace()">ğŸ’¾ Enregistrer la course</button>
      <p style="text-align:center;font-size:12px;color:var(--text3);margin-top:10px">â³ Visible aprÃ¨s validation par l'admin</p>
    </div>
  </div>

  <div id="page-races" class="page">
    <div class="page-title">Mes courses</div>
    <div class="stats-grid">
      <div class="stat-box"><div class="stat-box-val" id="st-total">â€”</div><div class="stat-box-label">Courses</div></div>
      <div class="stat-box"><div class="stat-box-val" id="st-km">â€”</div><div class="stat-box-label">km totaux</div></div>
      <div class="stat-box"><div class="stat-box-val" id="st-dp">â€”</div><div class="stat-box-label">D+ (m)</div></div>
      <div class="stat-box"><div class="stat-box-val" id="st-trails">â€”</div><div class="stat-box-label">Trails</div></div>
    </div>
    <div class="section-label">Historique</div>
    <div id="my-race-list"></div>
  </div>

  <div id="page-admin" class="page">
    <div class="page-title">Admin</div>
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchAdminTab('pending')">â³ En attente</button>
      <button class="admin-tab" onclick="switchAdminTab('users')">ğŸ‘¥ Utilisateurs</button>
      <button class="admin-tab" onclick="switchAdminTab('export')">ğŸ“Š Export</button>
    </div>
    <div id="admin-pending" class="admin-sub active"><div id="pending-list"></div></div>
    <div id="admin-users" class="admin-sub"><div id="admin-user-list"></div></div>
    <div id="admin-export" class="admin-sub">
      <div class="export-btn" onclick="exportMyData()">
        <div class="export-btn-info"><span style="font-size:22px">ğŸ“Š</span><div><div class="export-btn-label">Mes courses (CSV)</div><div class="export-btn-desc">Compatible Excel</div></div></div>
        <span style="color:var(--text3)">â€º</span>
      </div>
      <div class="export-btn" onclick="exportAllData()">
        <div class="export-btn-info"><span style="font-size:22px">ğŸ—‚ï¸</span><div><div class="export-btn-label">Export global (admin)</div><div class="export-btn-desc">Toutes les courses approuvÃ©es</div></div></div>
        <span style="color:var(--text3)">â€º</span>
      </div>
      <div class="section-label" style="margin-top:28px;margin-bottom:12px">RGPD</div>
      <div style="background:var(--bg2);border:1px solid rgba(239,68,68,0.2);border-radius:var(--radius-sm);padding:16px;font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:12px;">
        La suppression efface dÃ©finitivement toutes tes donnÃ©es (RGPD Art. 17).
      </div>
      <button class="btn-danger" onclick="deleteMyAccount()">ğŸ—‘ï¸ Supprimer mon compte</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-item active" onclick="showPage('feed')" id="nav-feed">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Accueil
    </button>
    <button class="nav-item" onclick="showPage('races')" id="nav-races">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Mes courses
    </button>
    <button class="nav-item" onclick="showPage('add')" id="nav-add">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Ajouter
    </button>
    <button class="nav-item" onclick="showPage('admin')" id="nav-admin" style="display:none">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>Admin
    </button>
  </nav>
</div>

<div class="modal-overlay" id="race-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-race-name">â€”</div>
    <div id="modal-content"></div>
    <button class="btn-outline" onclick="closeModal()">âœ• Fermer</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE â€” clÃ©s injectÃ©es par Vercel au build
// Dans Vercel > Settings > Environment Variables :
//   SUPABASE_URL = https://gixwqwbvcnfyllusdlkl.supabase.co
//   SUPABASE_KEY = ta_nouvelle_anon_key (aprÃ¨s reset)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = '%%SUPABASE_URL%%';
const SUPABASE_KEY = '%%SUPABASE_KEY%%';

let sb = null;
let currentUser = null;
let currentProfile = null;

async function initSupabase() {
  if (!SUPABASE_URL || SUPABASE_URL === '%%SUPABASE_URL%%') {
    console.warn('Supabase non configurÃ© â€” vÃ©rifier les variables Vercel');
    hideLoading(); showAuth(); return;
  }
  try {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { data:{ session } } = await sb.auth.getSession();
    if (session) { await loadProfile(session.user); launchApp(); }
    else showAuth();
  } catch(e) { console.error(e); showAuth(); }
  hideLoading();
}

function hideLoading(){ document.getElementById('loading-screen').style.display='none'; }
function showAuth(){ document.getElementById('auth-screen').style.display='flex'; }

async function loadProfile(user) {
  currentUser = user;
  if (!sb) return;
  const { data } = await sb.from('profils').select('*').eq('id', user.id).single();
  currentProfile = data;
}

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('login-form').style.display = tab==='login'?'block':'none';
  document.getElementById('register-form').style.display = tab==='register'?'block':'none';
}

async function login() {
  const email = document.getElementById('login-email').value.trim();
  const pwd   = document.getElementById('login-password').value;
  const btn   = document.getElementById('login-btn');
  const err   = document.getElementById('login-error');
  err.style.display='none';
  if (!email||!pwd){ showErr(err,'Remplis tous les champs'); return; }
  if (!sb){ showErr(err,'Supabase non configurÃ© â€” vÃ©rifier Vercel'); return; }
  btn.disabled=true; btn.textContent='Connexionâ€¦';
  const { error } = await sb.auth.signInWithPassword({ email, password: pwd });
  if (error){ showErr(err, error.message==='Invalid login credentials'?'Email ou mot de passe incorrect':error.message); btn.disabled=false; btn.textContent='Se connecter'; return; }
  const { data:{ user } } = await sb.auth.getUser();
  await loadProfile(user);
  document.getElementById('auth-screen').style.display='none';
  launchApp();
}

async function register() {
  const pseudo  = document.getElementById('reg-pseudo').value.trim();
  const email   = document.getElementById('reg-email').value.trim();
  const pwd     = document.getElementById('reg-password').value;
  const country = document.getElementById('reg-country').value;
  const btn     = document.getElementById('register-btn');
  const err     = document.getElementById('register-error');
  err.style.display='none';
  if (!pseudo||!email||!pwd||!country){ showErr(err,'Tous les champs sont requis'); return; }
  if (pwd.length<6){ showErr(err,'Mot de passe trop court (6 min)'); return; }
  if (!sb){ showErr(err,'Supabase non configurÃ©'); return; }
  btn.disabled=true; btn.textContent='CrÃ©ationâ€¦';
  const { data, error } = await sb.auth.signUp({ email, password: pwd });
  if (error){ showErr(err,error.message); btn.disabled=false; btn.textContent='CrÃ©er mon compte'; return; }
  // Premier utilisateur = admin
  const { count } = await sb.from('profils').select('*', { count:'exact', head:true });
  const isAdmin = count === 0;
  const { error: pe } = await sb.from('profils').insert({ id:data.user.id, pseudo, pays:country, est_admin:isAdmin });
  if (pe){ showErr(err,pe.message); btn.disabled=false; btn.textContent='CrÃ©er mon compte'; return; }
  await loadProfile(data.user);
  document.getElementById('auth-screen').style.display='none';
  launchApp();
}

async function logout() {
  if (sb) await sb.auth.signOut();
  currentUser=null; currentProfile=null;
  document.getElementById('app').style.display='none';
  document.getElementById('auth-screen').style.display='flex';
}

function showErr(el,msg){ el.textContent=msg; el.style.display='block'; }

// â”€â”€ LAUNCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function launchApp() {
  document.getElementById('app').style.display='block';
  const pseudo = currentProfile?.pseudo || currentUser?.email?.split('@')[0] || 'AthlÃ¨te';
  document.getElementById('topbar-pseudo').textContent = pseudo;
  document.getElementById('topbar-avatar').textContent = pseudo[0].toUpperCase();
  if (currentProfile?.est_admin) document.getElementById('nav-admin').style.display='flex';
  renderFeed(); renderMyRaces();
  if (currentProfile?.est_admin){ renderPending(); renderAdminUsers(); }
  showPage('feed');
}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
}
function switchAdminTab(tab) {
  document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.admin-sub').forEach(s=>s.classList.remove('active'));
  document.getElementById('admin-'+tab).classList.add('active');
}

// â”€â”€ SPORT FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedSport = null;
function selectSport(type) {
  selectedSport=type;
  ['trail','run','tri'].forEach(s=>document.getElementById('btn-'+s).className='sport-btn');
  document.getElementById('btn-'+type).className='sport-btn active-'+type;
  document.getElementById('form-trail-run').style.display=(type==='trail'||type==='run')?'block':'none';
  document.getElementById('form-tri').style.display=type==='tri'?'block':'none';
  document.getElementById('save-btn-wrap').style.display='block';
}

// â”€â”€ PACE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeToSecs(t) {
  if (!t) return 0;
  const p=String(t).split(':').map(Number);
  if (p.length===3) return p[0]*3600+p[1]*60+p[2];
  if (p.length===2) return p[0]*60+p[1];
  return 0;
}
function secsToHMS(s) {
  const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=Math.round(s%60);
  if (h>0) return `${h}h${String(m).padStart(2,'0')}m${String(sec).padStart(2,'0')}s`;
  return `${m}m${String(sec).padStart(2,'0')}s`;
}
function calcPace(distKm, timeStr, type='run') {
  const secs=timeToSecs(timeStr);
  if (!distKm||!secs) return 'â€”';
  if (type==='swim'){ return secsToHMS(secs/(distKm*10))+'/100m'; }
  if (type==='bike'){ return (distKm/secs*3600).toFixed(1)+' km/h'; }
  const spk=secs/distKm,m=Math.floor(spk/60),s=Math.round(spk%60);
  return `${m}'${String(s).padStart(2,'0')}"/km`;
}
function triTotalTime(segs) {
  const t=segs.reduce((a,s)=>a+timeToSecs(s.temps),0);
  const h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;
  return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// â”€â”€ SAVE RACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveRace() {
  if (!selectedSport){ showToast('âš ï¸ SÃ©lectionne un sport'); return; }
  const nom  = document.getElementById('race-name').value.trim();
  const date = document.getElementById('race-date').value;
  if (!nom||!date){ showToast('âš ï¸ Nom et date requis'); return; }
  if (!sb){ showToast('âš ï¸ Supabase non configurÃ©'); return; }

  const payload = {
    user_id: currentUser.id, type: selectedSport,
    nom, date, lieu: document.getElementById('race-location').value.trim(),
    statut: 'en_attente'
  };
  if (selectedSport==='trail'||selectedSport==='run') {
    payload.distance_km = parseFloat(document.getElementById('tr-distance').value)||null;
    payload.denivele_m  = parseInt(document.getElementById('tr-denivele').value)||0;
    payload.temps       = document.getElementById('tr-time').value||null;
  }
  const { data:course, error:ce } = await sb.from('courses').insert(payload).select().single();
  if (ce){ showToast('âŒ '+ce.message); return; }

  if (selectedSport==='tri') {
    const segments = [
      { course_id:course.id, type:'swim', distance_km:(parseInt(document.getElementById('tri-swim-dist').value)||0)/1000, denivele_m:0, temps:document.getElementById('tri-swim-time').value },
      { course_id:course.id, type:'t1',   distance_km:0, denivele_m:0, temps:document.getElementById('tri-t1').value },
      { course_id:course.id, type:'bike', distance_km:parseFloat(document.getElementById('tri-bike-dist').value)||0, denivele_m:parseInt(document.getElementById('tri-bike-denivele').value)||0, temps:document.getElementById('tri-bike-time').value },
      { course_id:course.id, type:'t2',   distance_km:0, denivele_m:0, temps:document.getElementById('tri-t2').value },
      { course_id:course.id, type:'run',  distance_km:parseFloat(document.getElementById('tri-run-dist').value)||0, denivele_m:parseInt(document.getElementById('tri-run-denivele').value)||0, temps:document.getElementById('tri-run-time').value },
    ];
    const { error:se } = await sb.from('tri_segments').insert(segments);
    if (se){ showToast('âŒ Segments : '+se.message); return; }
  }

  showToast('âœ… Course enregistrÃ©e â€” en attente de validation');
  resetForm(); renderMyRaces();
  if (currentProfile?.est_admin) renderPending();
  setTimeout(()=>showPage('races'), 800);
}

function resetForm() {
  ['race-name','race-date','race-location','tr-distance','tr-denivele','tr-time',
   'tri-swim-dist','tri-swim-time','tri-t1','tri-bike-dist','tri-bike-denivele',
   'tri-bike-time','tri-t2','tri-run-dist','tri-run-denivele','tri-run-time'
  ].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
  selectedSport=null;
  ['trail','run','tri'].forEach(s=>document.getElementById('btn-'+s).className='sport-btn');
  document.getElementById('form-trail-run').style.display='none';
  document.getElementById('form-tri').style.display='none';
  document.getElementById('save-btn-wrap').style.display='none';
}

// â”€â”€ FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderFeed() {
  const container=document.getElementById('feed-list');
  container.innerHTML='<div class="empty-state"><div class="empty-state-icon">â³</div><div class="empty-state-title">Chargementâ€¦</div></div>';
  if (!sb) return;
  const { data:races } = await sb.from('courses')
    .select('*, profils(pseudo), tri_segments(*)')
    .eq('statut','approuvÃ©')
    .order('created_at',{ascending:false}).limit(30);
  if (!races||races.length===0){
    container.innerHTML='<div class="empty-state"><div class="empty-state-icon">ğŸ</div><div class="empty-state-title">Aucune course approuvÃ©e</div><div class="empty-state-text">Les courses apparaÃ®tront ici une fois validÃ©es par l\'admin.</div></div>';
    return;
  }
  const { data:myLikes } = await sb.from('likes').select('course_id').eq('user_id',currentUser.id);
  const likedIds = new Set((myLikes||[]).map(l=>l.course_id));
  const { data:lkAll } = await sb.from('likes').select('course_id');
  const countMap={};
  (lkAll||[]).forEach(l=>{ countMap[l.course_id]=(countMap[l.course_id]||0)+1; });
  container.innerHTML = races.map((r,i)=>buildFeedCard(r,likedIds,countMap,i)).join('');
}

function buildFeedCard(r, likedIds, countMap, idx) {
  const pseudo=r.profils?.pseudo||'AthlÃ¨te';
  const liked=likedIds.has(r.id);
  const likeCount=countMap[r.id]||0;
  const isMe=r.user_id===currentUser?.id;
  const dateStr=new Date(r.date).toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
  const bc=r.type==='trail'?'badge-trail':r.type==='run'?'badge-run':'badge-tri';
  const bl=r.type==='trail'?'Trail':r.type==='run'?'Running':'Triathlon';
  let stats='', segs='';
  if (r.type==='tri') {
    const sg=r.tri_segments||[];
    const swim=sg.find(s=>s.type==='swim')||{};
    const bike=sg.find(s=>s.type==='bike')||{};
    const run=sg.find(s=>s.type==='run')||{};
    const t1=sg.find(s=>s.type==='t1')||{};
    const t2=sg.find(s=>s.type==='t2')||{};
    const td=((swim.distance_km||0)+(bike.distance_km||0)+(run.distance_km||0)).toFixed(1);
    const tt=triTotalTime(sg);
    stats=`<div class="feed-stats"><div class="stat-cell"><div class="stat-val">${tt}</div><div class="stat-label">Temps total</div></div><div class="stat-cell"><div class="stat-val">${td}km</div><div class="stat-label">Distance</div></div><div class="stat-cell"><div class="stat-val">${(bike.denivele_m||0)+(run.denivele_m||0)}m</div><div class="stat-label">D+</div></div></div>`;
    segs=`<div class="tri-segments">
      <div class="tri-segment"><div class="seg-icon">ğŸŠ</div><div class="seg-info"><div class="seg-name">Natation</div><div class="seg-detail">${Math.round((swim.distance_km||0)*1000)}m Â· ${calcPace(swim.distance_km,swim.temps,'swim')}</div></div><div class="seg-time seg-swim">${swim.temps||'â€”'}</div></div>
      <div class="tri-segment" style="opacity:0.6"><div class="seg-icon">â‡„</div><div class="seg-info"><div class="seg-name">T1</div></div><div class="seg-time" style="color:var(--text2)">${t1.temps||'â€”'}</div></div>
      <div class="tri-segment"><div class="seg-icon">ğŸš´</div><div class="seg-info"><div class="seg-name">VÃ©lo</div><div class="seg-detail">${bike.distance_km||0}km Â· ${calcPace(bike.distance_km,bike.temps,'bike')}</div></div><div class="seg-time seg-bike">${bike.temps||'â€”'}</div></div>
      <div class="tri-segment" style="opacity:0.6"><div class="seg-icon">â‡„</div><div class="seg-info"><div class="seg-name">T2</div></div><div class="seg-time" style="color:var(--text2)">${t2.temps||'â€”'}</div></div>
      <div class="tri-segment"><div class="seg-icon">ğŸƒ</div><div class="seg-info"><div class="seg-name">Course</div><div class="seg-detail">${run.distance_km||0}km Â· ${calcPace(run.distance_km,run.temps)}</div></div><div class="seg-time seg-run-c">${run.temps||'â€”'}</div></div>
    </div>`;
  } else {
    stats=`<div class="feed-stats"><div class="stat-cell"><div class="stat-val">${r.temps||'â€”'}</div><div class="stat-label">Temps</div></div><div class="stat-cell"><div class="stat-val">${r.distance_km||0}km</div><div class="stat-label">Distance</div></div><div class="stat-cell"><div class="stat-val">${r.denivele_m>0?r.denivele_m+'m':calcPace(r.distance_km,r.temps)}</div><div class="stat-label">${r.denivele_m>0?'D+':'Allure'}</div></div></div>`;
  }
  return `<div class="feed-card" style="animation-delay:${idx*0.05}s">
    <div class="feed-card-header">
      <div class="feed-avatar">${pseudo[0].toUpperCase()}</div>
      <div class="feed-meta"><div class="feed-name">${pseudo}</div><div class="feed-date">${dateStr}${r.lieu?' Â· '+r.lieu:''}</div></div>
      <span class="sport-badge ${bc}">${bl}</span>
    </div>
    <div class="feed-race-name">${r.nom}</div>
    ${segs}${stats}
    <div class="feed-actions">
      <button class="btn-like ${liked?'liked':''}" onclick="toggleLike('${r.id}')">
        <svg viewBox="0 0 24 24" fill="${liked?'currentColor':'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
        ${likeCount>0?likeCount+' ':''} ${liked?'AimÃ©':'Like'}
      </button>
      <button class="btn-like" onclick="openModal('${r.id}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        DÃ©tail
      </button>
      ${isMe?`<button class="btn-like" style="margin-left:auto;color:#ef4444;border-color:rgba(239,68,68,0.3)" onclick="deleteRace('${r.id}')">ğŸ—‘ï¸</button>`:''}
    </div>
  </div>`;
}

// â”€â”€ MY RACES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderMyRaces() {
  if (!sb||!currentUser) return;
  const { data:races } = await sb.from('courses').select('*, tri_segments(*)').eq('user_id',currentUser.id).order('date',{ascending:false});
  const all=races||[];
  let totalKm=0,totalD=0,trails=0;
  all.forEach(r=>{
    if (r.type==='tri'){ (r.tri_segments||[]).forEach(s=>{ totalKm+=s.distance_km||0; totalD+=s.denivele_m||0; }); }
    else { totalKm+=r.distance_km||0; totalD+=r.denivele_m||0; if(r.type==='trail') trails++; }
  });
  document.getElementById('st-total').textContent=all.length;
  document.getElementById('st-km').textContent=Math.round(totalKm);
  document.getElementById('st-dp').textContent=totalD.toLocaleString('fr-FR');
  document.getElementById('st-trails').textContent=trails;
  const clr={trail:'var(--accent-trail)',run:'var(--accent-run)',tri:'var(--accent-tri)'};
  const c=document.getElementById('my-race-list');
  if (all.length===0){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><div class="empty-state-title">Aucune course</div><div class="empty-state-text">Ajoute ta premiÃ¨re performance !</div></div>'; return; }
  c.innerHTML=all.map(r=>{
    const ds=new Date(r.date).toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'});
    const sb2=r.statut==='en_attente'?`<span class="pending-badge" style="font-size:9px;padding:2px 6px">â³ En attente</span>`:r.statut==='rejetÃ©'?`<span class="pending-badge" style="font-size:9px;padding:2px 6px;color:#ef4444;border-color:rgba(239,68,68,0.3);background:rgba(239,68,68,0.1)">âŒ RejetÃ©</span>`:'';
    let dist='â€”',time='â€”';
    if (r.type==='tri'){ const sg=r.tri_segments||[]; dist=sg.reduce((a,s)=>a+(s.distance_km||0),0).toFixed(1)+'km'; time=triTotalTime(sg); }
    else { dist=(r.distance_km||0)+'km'; time=r.temps||'â€”'; }
    return `<div class="race-list-item" onclick="openModal('${r.id}')">
      <div class="race-list-dot" style="background:${clr[r.type]}"></div>
      <div class="race-list-info"><div class="race-list-name">${r.nom} ${sb2}</div><div class="race-list-meta">${ds} Â· ${dist}</div></div>
      <div class="race-list-time">${time}</div>
    </div>`;
  }).join('');
}

// â”€â”€ ADMIN PENDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderPending() {
  if (!sb) return;
  const { data:races } = await sb.from('courses').select('*, profils(pseudo), tri_segments(*)').eq('statut','en_attente').order('created_at');
  const c=document.getElementById('pending-list');
  if (!races||races.length===0){ c.innerHTML='<div class="empty-state"><div class="empty-state-icon">âœ…</div><div class="empty-state-title">Aucune course en attente</div></div>'; return; }
  c.innerHTML=races.map(r=>{
    const pseudo=r.profils?.pseudo||'?';
    const ds=new Date(r.date).toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'});
    let detail='';
    if (r.type==='tri'){
      const sg=r.tri_segments||[];
      const swim=sg.find(s=>s.type==='swim')||{};
      const bike=sg.find(s=>s.type==='bike')||{};
      const run=sg.find(s=>s.type==='run')||{};
      detail=`ğŸŠ ${Math.round((swim.distance_km||0)*1000)}m &nbsp;ğŸš´ ${bike.distance_km||0}km &nbsp;ğŸƒ ${run.distance_km||0}km`;
    } else { detail=`${r.distance_km||0}km Â· D+ ${r.denivele_m||0}m Â· ${r.temps||'â€”'}`; }
    return `<div class="pending-card">
      <div class="pending-card-header"><div class="pending-card-name">${r.nom}</div><span class="pending-badge">â³</span></div>
      <div class="pending-card-meta">ğŸ‘¤ ${pseudo} Â· ğŸ“… ${ds}${r.lieu?' Â· '+r.lieu:''}</div>
      <div class="pending-card-meta" style="font-family:'DM Mono',monospace;font-size:12px">${detail}</div>
      <div class="pending-actions">
        <button class="btn-approve" onclick="approveRace('${r.id}')">âœ… Approuver</button>
        <button class="btn-reject" onclick="rejectRace('${r.id}')">âŒ Rejeter</button>
      </div>
    </div>`;
  }).join('');
}

async function approveRace(id) {
  await sb.from('courses').update({statut:'approuvÃ©'}).eq('id',id);
  showToast('âœ… Course approuvÃ©e !'); renderPending(); renderFeed(); renderMyRaces();
}
async function rejectRace(id) {
  await sb.from('courses').update({statut:'rejetÃ©'}).eq('id',id);
  showToast('ğŸš« Course rejetÃ©e'); renderPending(); renderMyRaces();
}

// â”€â”€ ADMIN USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderAdminUsers() {
  if (!sb) return;
  const { data:users } = await sb.from('profils').select('*').order('created_at');
  const c=document.getElementById('admin-user-list');
  if (!users||users.length===0){ c.innerHTML='<p style="color:var(--text3)">Aucun utilisateur</p>'; return; }
  c.innerHTML=users.map(u=>`
    <div class="admin-user-row">
      <div class="admin-avatar">${u.pseudo[0].toUpperCase()}</div>
      <div class="admin-user-info">
        <div class="admin-user-name">${u.pseudo} ${u.est_admin?'ğŸ‘‘':''}</div>
        <div class="admin-user-meta">${u.pays||'â€”'} Â· ${new Date(u.created_at).toLocaleDateString('fr-FR')}</div>
      </div>
      ${u.id!==currentUser?.id?`<button class="btn-sm-danger" onclick="adminDeleteUser('${u.id}')">Suppr.</button>`:''}
    </div>`).join('');
}

async function adminDeleteUser(uid) {
  if (!confirm('Supprimer cet utilisateur et toutes ses donnÃ©es (RGPD Art.17) ?')) return;
  await sb.from('tri_segments').delete().in('course_id', (await sb.from('courses').select('id').eq('user_id',uid)).data?.map(r=>r.id)||[]);
  await sb.from('courses').delete().eq('user_id',uid);
  await sb.from('likes').delete().eq('user_id',uid);
  await sb.from('profils').delete().eq('id',uid);
  showToast('âœ… Utilisateur supprimÃ©'); renderAdminUsers(); renderFeed();
}

// â”€â”€ LIKES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleLike(courseId) {
  if (!sb||!currentUser) return;
  const { data:ex } = await sb.from('likes').select('*').eq('user_id',currentUser.id).eq('course_id',courseId).maybeSingle();
  if (ex) await sb.from('likes').delete().eq('user_id',currentUser.id).eq('course_id',courseId);
  else await sb.from('likes').insert({user_id:currentUser.id, course_id:courseId});
  renderFeed();
}

// â”€â”€ DELETE RACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function deleteRace(id) {
  if (!confirm('Supprimer cette course ?')) return;
  await sb.from('tri_segments').delete().eq('course_id',id);
  await sb.from('likes').delete().eq('course_id',id);
  await sb.from('courses').delete().eq('id',id);
  showToast('ğŸ—‘ï¸ Course supprimÃ©e'); renderFeed(); renderMyRaces();
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openModal(raceId) {
  if (!sb) return;
  const { data:r } = await sb.from('courses').select('*, profils(pseudo), tri_segments(*)').eq('id',raceId).single();
  if (!r) return;
  document.getElementById('modal-race-name').textContent=r.nom;
  const ds=new Date(r.date).toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
  let html=`<div style="color:var(--text3);font-size:13px;margin-bottom:16px">${ds}${r.lieu?' Â· '+r.lieu:''} Â· <b style="color:var(--text2)">${r.profils?.pseudo||'AthlÃ¨te'}</b></div>`;
  if (r.type==='tri') {
    const sg=r.tri_segments||[];
    const swim=sg.find(s=>s.type==='swim')||{};
    const t1=sg.find(s=>s.type==='t1')||{};
    const bike=sg.find(s=>s.type==='bike')||{};
    const t2=sg.find(s=>s.type==='t2')||{};
    const run=sg.find(s=>s.type==='run')||{};
    html+=`<div class="detail-stat-grid"><div class="detail-stat"><div class="detail-stat-val">${triTotalTime(sg)}</div><div class="detail-stat-label">Temps total</div></div><div class="detail-stat"><div class="detail-stat-val">${((swim.distance_km||0)+(bike.distance_km||0)+(run.distance_km||0)).toFixed(1)}km</div><div class="detail-stat-label">Distance</div></div></div>`;
    html+=`<div style="margin:16px 0 10px;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text3)">Segments</div>`;
    html+=`<div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:8px"><div style="color:var(--accent-swim);font-size:12px;font-weight:600;margin-bottom:8px">ğŸŠ NATATION</div><div class="detail-stat-grid"><div class="detail-stat"><div class="detail-stat-val">${Math.round((swim.distance_km||0)*1000)}m</div><div class="detail-stat-label">Distance</div></div><div class="detail-stat"><div class="detail-stat-val">${swim.temps||'â€”'}</div><div class="detail-stat-label">Temps</div></div><div class="detail-stat" style="grid-column:span 2"><div class="detail-stat-val">${calcPace(swim.distance_km,swim.temps,'swim')}</div><div class="detail-stat-label">Allure</div></div></div></div>`;
    html+=`<div style="text-align:center;padding:8px;color:var(--text3);font-size:12px">â‡„ Transition T1 : ${t1.temps||'â€”'}</div>`;
    html+=`<div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:8px"><div style="color:var(--accent-bike);font-size:12px;font-weight:600;margin-bottom:8px">ğŸš´ VÃ‰LO</div><div class="detail-stat-grid"><div class="detail-stat"><div class="detail-stat-val">${bike.distance_km||0}km</div><div class="detail-stat-label">Distance</div></div><div class="detail-stat"><div class="detail-stat-val">${bike.denivele_m||0}m</div><div class="detail-stat-label">D+</div></div><div class="detail-stat"><div class="detail-stat-val">${bike.temps||'â€”'}</div><div class="detail-stat-label">Temps</div></div><div class="detail-stat"><div class="detail-stat-val">${calcPace(bike.distance_km,bike.temps,'bike')}</div><div class="detail-stat-label">Vitesse</div></div></div></div>`;
    html+=`<div style="text-align:center;padding:8px;color:var(--text3);font-size:12px">â‡„ Transition T2 : ${t2.temps||'â€”'}</div>`;
    html+=`<div style="background:var(--bg3);border-radius:12px;padding:16px;margin-bottom:16px"><div style="color:var(--accent-run);font-size:12px;font-weight:600;margin-bottom:8px">ğŸƒ COURSE</div><div class="detail-stat-grid"><div class="detail-stat"><div class="detail-stat-val">${run.distance_km||0}km</div><div class="detail-stat-label">Distance</div></div><div class="detail-stat"><div class="detail-stat-val">${run.denivele_m||0}m</div><div class="detail-stat-label">D+</div></div><div class="detail-stat"><div class="detail-stat-val">${run.temps||'â€”'}</div><div class="detail-stat-label">Temps</div></div><div class="detail-stat"><div class="detail-stat-val">${calcPace(run.distance_km,run.temps)}</div><div class="detail-stat-label">Allure</div></div></div></div>`;
  } else {
    html+=`<div class="detail-stat-grid"><div class="detail-stat"><div class="detail-stat-val">${r.temps||'â€”'}</div><div class="detail-stat-label">Temps</div></div><div class="detail-stat"><div class="detail-stat-val">${r.distance_km||0}km</div><div class="detail-stat-label">Distance</div></div><div class="detail-stat"><div class="detail-stat-val">${r.denivele_m||0}m</div><div class="detail-stat-label">D+</div></div><div class="detail-stat"><div class="detail-stat-val">${calcPace(r.distance_km,r.temps)}</div><div class="detail-stat-label">Allure</div></div></div>`;
  }
  document.getElementById('modal-content').innerHTML=html;
  document.getElementById('race-modal').classList.add('open');
}
function closeModal(){ document.getElementById('race-modal').classList.remove('open'); }
document.getElementById('race-modal').addEventListener('click',function(e){ if(e.target===this) closeModal(); });

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportMyData() {
  if (!sb||!currentUser) return;
  const { data:races } = await sb.from('courses').select('*, tri_segments(*)').eq('user_id',currentUser.id);
  let csv='Nom,Date,Sport,Lieu,Statut,Distance_km,Denivele_m,Temps,Allure\n';
  (races||[]).forEach(r=>{
    if (r.type==='tri'){ const sg=r.tri_segments||[]; const d=sg.reduce((a,s)=>a+(s.distance_km||0),0); const t=triTotalTime(sg); csv+=`"${r.nom}","${r.date}","Triathlon","${r.lieu||''}","${r.statut}","${d.toFixed(1)}","â€”","${t}","Multi-sport"\n`; }
    else { csv+=`"${r.nom}","${r.date}","${r.type}","${r.lieu||''}","${r.statut}","${r.distance_km||0}","${r.denivele_m||0}","${r.temps||''}","${calcPace(r.distance_km,r.temps)}"\n`; }
  });
  dlCSV(csv,`enduro_mescourses_${new Date().toISOString().split('T')[0]}.csv`);
  showToast('ğŸ“Š Export tÃ©lÃ©chargÃ© !');
}
async function exportAllData() {
  if (!sb) return;
  const { data:races } = await sb.from('courses').select('*, profils(pseudo), tri_segments(*)').eq('statut','approuvÃ©');
  let csv='Athlete,Nom_course,Date,Sport,Lieu,Distance_km,Denivele_m,Temps\n';
  (races||[]).forEach(r=>{
    const u=r.profils?.pseudo||'?';
    if (r.type==='tri'){ const sg=r.tri_segments||[]; const d=sg.reduce((a,s)=>a+(s.distance_km||0),0); csv+=`"${u}","${r.nom}","${r.date}","Triathlon","${r.lieu||''}","${d.toFixed(1)}","â€”","${triTotalTime(sg)}"\n`; }
    else { csv+=`"${u}","${r.nom}","${r.date}","${r.type}","${r.lieu||''}","${r.distance_km||0}","${r.denivele_m||0}","${r.temps||''}"\n`; }
  });
  dlCSV(csv,`enduro_global_${new Date().toISOString().split('T')[0]}.csv`);
  showToast('ğŸ—‚ï¸ Export global tÃ©lÃ©chargÃ© !');
}
function dlCSV(content,filename){ const b=new Blob(['\ufeff'+content],{type:'text/csv;charset=utf-8;'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=filename; a.click(); }

async function deleteMyAccount() {
  if (!confirm('Supprimer dÃ©finitivement ton compte et toutes tes donnÃ©es ?\n\nIrrÃ©versible â€” RGPD Art. 17')) return;
  const uid=currentUser.id;
  const { data:myRaces } = await sb.from('courses').select('id').eq('user_id',uid);
  const ids=(myRaces||[]).map(r=>r.id);
  if (ids.length) await sb.from('tri_segments').delete().in('course_id',ids);
  await sb.from('courses').delete().eq('user_id',uid);
  await sb.from('likes').delete().eq('user_id',uid);
  await sb.from('profils').delete().eq('id',uid);
  await sb.auth.signOut();
  document.getElementById('app').style.display='none';
  document.getElementById('auth-screen').style.display='flex';
  showToast('âœ… Compte supprimÃ©');
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800); }

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initSupabase();
</script>
</body>
</html>
